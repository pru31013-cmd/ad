<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üÉè Blackjack</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #0a1f0a;
            color: white;
            min-height: 100vh;
        }
        
        #app {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* Header */
        .header {
            background: #1a3a1a;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #2a4a2a;
        }
        
        .header h1 {
            font-size: 20px;
            color: #ffd700;
        }
        
        .balance {
            background: #2a4a2a;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: #ffd700;
        }
        
        /* Butonlar */
        .btn {
            background: #2a4a2a;
            border: 1px solid #3a5a3a;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        
        .btn:active {
            background: #3a5a3a;
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #ffd700;
            color: #1a3a1a;
            border: none;
        }
        
        .btn-primary:active {
            background: #e6c200;
        }
        
        .btn-danger {
            background: #c41e3a;
            color: white;
            border: none;
        }
        
        /* Kartlar */
        .cards {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }
        
        .card {
            background: white;
            color: black;
            width: 60px;
            height: 84px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .card.red {
            color: #c41e3a;
        }
        
        .card.back {
            background: linear-gradient(135deg, #1a3a1a, #2a4a2a);
            color: #ffd700;
        }
        
        /* Oyun alanƒ± */
        .table {
            background: #1a5a1a;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #ffd700;
        }
        
        .player-row {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-row.my-turn {
            border: 2px solid #ffd700;
            background: rgba(255,215,0,0.1);
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            background: #2a4a2a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-weight: bold;
        }
        
        .player-chips {
            font-size: 12px;
            color: #ffd700;
        }
        
        /* Bahis */
        .bet-section {
            background: #1a3a1a;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
        }
        
        .bet-display {
            font-size: 32px;
            color: #ffd700;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .chip-presets {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .chip-btn {
            flex: 1;
            background: #2a4a2a;
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 8px;
            border-radius: 20px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Pot */
        .pot {
            text-align: center;
            margin: 16px 0;
        }
        
        .pot-amount {
            font-size: 24px;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* Timer */
        .timer {
            height: 4px;
            background: #2a4a2a;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .timer-bar {
            height: 100%;
            background: #ffd700;
            transition: width 1s linear;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a3a1a;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: 1px solid #ffd700;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a3a1a;
            padding: 24px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            border: 2px solid #ffd700;
        }
        
        .modal input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #2a4a2a;
            border: 1px solid #3a5a3a;
            border-radius: 8px;
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-8 {
            margin-top: 8px;
        }
        
        .mt-16 {
            margin-top: 16px;
        }
        
        .mb-8 {
            margin-bottom: 8px;
        }
        
        .gap-8 {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .row {
            display: flex;
            gap: 10px;
        }
        
        .row .btn {
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- HEADER -->
        <div class="header">
            <h1>üÉè Blackjack</h1>
            <div class="balance" id="balance">üí∞ 1000</div>
        </div>
        
        <!-- LOBBY EKRANI -->
        <div id="lobby-screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="font-size: 13px; color: #888;" id="last-refresh-text">Y√ºkleniyor...</div>
                <button class="btn" id="refresh-btn" onclick="manualRefresh()" style="width: auto; padding: 8px 14px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                    üîÑ Yenile
                </button>
            </div>
            <div id="tables-list"></div>
            <button class="btn btn-primary mt-16" onclick="showCreateTable()">‚ûï Masa Olu≈ütur</button>
        </div>
        
        <!-- BEKLEME ODASI EKRANI -->
        <div id="waiting-screen" class="hidden">
            <div class="table">
                <h2 id="waiting-table-name">Masa Adƒ±</h2>
                <div id="waiting-players"></div>
                <div class="row mt-16">
                    <button id="start-game-btn" class="btn btn-primary hidden" onclick="startGame()">üéÆ Ba≈ülat</button>
                    <button class="btn btn-danger" onclick="leaveTable()">üëã Ayrƒ±l</button>
                </div>
            </div>
        </div>
        
        <!-- OYUN EKRANI -->
        <div id="game-screen" class="hidden">
            <!-- Pot -->
            <div class="pot">
                <div>POT</div>
                <div class="pot-amount" id="pot">0</div>
            </div>
            
            <!-- Timer -->
            <div class="timer">
                <div class="timer-bar" id="timer-bar" style="width: 100%"></div>
            </div>
            
            <!-- Diƒüer Oyuncular -->
            <div class="table">
                <div id="other-players"></div>
            </div>
            
            <!-- Benim Elim -->
            <div class="table">
                <div class="cards" id="my-cards"></div>
                <div class="text-center mt-8">
                    <span id="hand-value">0</span>
                </div>
            </div>
            
            <!-- Bahis Alanƒ± -->
            <div id="bet-area" class="bet-section hidden">
                <div class="bet-display" id="bet-amount">10</div>
                <input type="range" class="slider" id="bet-slider" min="10" max="100" value="10" step="5" oninput="updateBet(this.value)">
                <div class="chip-presets" id="chip-presets"></div>
                <button class="btn btn-primary mt-8" onclick="placeBet()">‚úÖ Bahsi Onayla</button>
            </div>
            
            <!-- Oyun Alanƒ± -->
            <div id="game-area" class="hidden">
                <div class="row">
                    <button class="btn btn-primary" onclick="hit()">üÉè HIT</button>
                    <button class="btn btn-danger" onclick="stand()">‚úã STAND</button>
                </div>
            </div>
            
            <!-- Bekleme Alanƒ± -->
            <div id="waiting-area" class="hidden">
                <div class="text-center">‚è≥ <span id="current-turn"></span> oynuyor...</div>
            </div>
            
            <!-- Devam Etme -->
            <div id="continue-area" class="hidden">
                <div class="text-center mb-8">Yeni el oynanacak mƒ±?</div>
                <div class="row">
                    <button class="btn btn-primary" onclick="vote('continue')">‚úÖ DEVAM</button>
                    <button class="btn btn-danger" onclick="vote('leave')">‚ùå AYRIL</button>
                </div>
            </div>
            
            <button class="btn mt-16" onclick="leaveTable()">‚Üê √áƒ±kƒ±≈ü</button>
        </div>
    </div>
    
    <!-- TOAST -->
    <div id="toast"></div>
    
    <!-- MODAL -->
    <div id="modal" class="modal hidden" onclick="if(event.target===this) hideModal()">
        <div class="modal-content">
            <h2 id="modal-title">Masa Olu≈ütur</h2>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script>
        // ================== CONFIG ==================
        const IS_DEV = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const DEV_USER_ID = Math.floor(Math.random() * 10000).toString();
        
        console.log('üöÄ App ba≈ülatƒ±lƒ±yor...');
        console.log('üíª Mod:', IS_DEV ? 'Geli≈ütirme' : 'Production');
        console.log('üÜî Kullanƒ±cƒ±:', DEV_USER_ID);
        
        // ================== STATE ==================
        let ws = null;
        let currentTableId = null;
        let timerInterval = null;
        
        // ================== TELEGRAM ==================
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }
        
        // ================== API ==================
        async function api(method, path, body) {
            const headers = { 'Content-Type': 'application/json' };
            
            if (IS_DEV) {
                headers['x-dev-user-id'] = DEV_USER_ID;
                headers['x-dev-name'] = 'TestUser';
                headers['x-dev-username'] = 'testuser';
            } else {
                headers['x-telegram-init-data'] = tg?.initData || '';
            }
            
            try {
                console.log(`üì° ${method} ${path}`, body || '');
                const res = await fetch(path, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : undefined
                });
                
                const data = await res.json();
                if (data.error) {
                    showToast(data.error);
                    throw new Error(data.error);
                }
                return data;
            } catch (error) {
                console.error('‚ùå API Hatasƒ±:', error);
                showToast('Sunucu hatasƒ±');
                throw error;
            }
        }
        
        // ================== WEBSOCKET ==================
        function connectWS() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = IS_DEV 
                ? `${protocol}//${window.location.host}?devUserId=${DEV_USER_ID}`
                : `${protocol}//${window.location.host}?initData=${tg?.initData || ''}`;
            
            console.log('üîå WebSocket baƒülanƒ±yor:', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket baƒülandƒ±');
                showToast('Sunucuya baƒülandƒ±');
            };
            
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                console.log('üì® Mesaj:', msg.type, msg);
                handleMessage(msg);
            };
            
            ws.onclose = () => {
                console.log('‚ùå WebSocket kapandƒ±');
                setTimeout(connectWS, 3000);
            };
            
            ws.onerror = (err) => {
                console.error('‚ùå WebSocket hatasƒ±:', err);
            };
        }
        
        // ================== MESAJ Y√ñNETƒ∞Cƒ∞ ==================
        function handleMessage(msg) {
            switch (msg.type) {
                case 'STATE_UPDATE':
                    updateUI(msg.data);
                    break;
                    
                case 'HAND_RESULT':
                    showResult(msg);
                    break;
                    
                case 'NOTIFY':
                    showToast(msg.message);
                    break;
                    
                case 'ASK_CONTINUE':
                    showContinueUI();
                    break;
                    
                case 'KICKED':
                    showToast('üí∏ Chip bitti! Masadan atƒ±ldƒ±n');
                    setTimeout(() => showLobby(), 2000);
                    break;
                    
                case 'GAME_ENDED':
                    showToast('üèÅ Oyun bitti');
                    setTimeout(() => showLobby(), 2000);
                    break;
                    
                case 'CONNECTED':
                    console.log('‚úÖ Baƒülantƒ± ID:', msg.userId);
                    break;
            }
        }
        
        // ================== UI G√úNCELLEME ==================
        function updateUI(data) {
            currentTableId = data.tableId;
            
            // Balance g√ºncelle
            document.getElementById('balance').textContent = `üí∞ ${data.myChips}`;
            
            // Hangi ekran?
            if (data.tableStatus === 'waiting') {
                showWaitingRoom(data);
            } else {
                showGameScreen(data);
            }
        }
        
        // ================== LOBBY ==================
        let autoRefreshInterval = null;

        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                const lobbyVisible = !document.getElementById('lobby-screen').classList.contains('hidden');
                if (lobbyVisible) loadTables();
            }, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refresh-btn');
            btn.textContent = '‚è≥ Y√ºkleniyor...';
            btn.disabled = true;
            await loadTables();
            setTimeout(() => {
                btn.innerHTML = 'üîÑ Yenile';
                btn.disabled = false;
            }, 500);
        }

        async function loadTables() {
            try {
                const data = await api('GET', '/api/tables');
                renderTables(data.tables);
                const now = new Date();
                const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const el = document.getElementById('last-refresh-text');
                if (el) el.textContent = `üïê Son yenileme: ${timeStr}`;
            } catch (error) {
                document.getElementById('tables-list').innerHTML = '<div class="text-center">‚ùå Y√ºklenemedi</div>';
            }
        }
        
        function renderTables(tables) {
            const container = document.getElementById('tables-list');
            
            if (!tables || tables.length === 0) {
                container.innerHTML = `
                    <div class="text-center">
                        <div style="font-size: 48px; margin: 20px">üÉè</div>
                        <div>Hi√ß masa yok</div>
                        <div class="text-center" style="color: #ffd700; margin-top: 8px">ƒ∞lk masayƒ± sen a√ß!</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tables.map(table => `
                <div class="table" style="cursor: pointer; margin-bottom: 12px;" onclick="joinTable(${table.id}, ${!!table.password})">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; font-size: 18px;">
                                ${table.password ? 'üîí ' : ''}${table.name}
                            </div>
                            <div style="color: #ffd700; font-size: 14px;">
                                ${table.player_count}/8 oyuncu ‚Ä¢ ${table.start_chips} chip
                            </div>
                        </div>
                        <div>
                            <span style="background: ${table.status === 'playing' ? '#c41e3a' : '#2a4a2a'}; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                ${table.status === 'playing' ? '‚ö° OYUNDA' : '‚úÖ A√áIK'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ================== MASA ƒ∞≈ûLEMLERƒ∞ ==================
        function showCreateTable() {
            document.getElementById('modal-title').textContent = '‚ûï Yeni Masa';
            document.getElementById('modal-body').innerHTML = `
                <input type="text" id="table-name" placeholder="Masa Adƒ±" maxlength="30">
                <input type="number" id="start-chips" placeholder="Ba≈ülangƒ±√ß Chip" value="100" min="10" max="10000">
                <input type="password" id="table-password" placeholder="≈ûifre (opsiyonel)">
                <button class="btn btn-primary" onclick="createTable()">‚úÖ Olu≈ütur</button>
            `;
            showModal();
        }
        
        async function createTable() {
            const name = document.getElementById('table-name').value.trim();
            const start_chips = parseInt(document.getElementById('start-chips').value);
            const password = document.getElementById('table-password').value || null;
            
            if (!name) {
                showToast('Masa adƒ± gerekli');
                return;
            }
            
            hideModal();
            await api('POST', '/api/tables', { name, start_chips, password });
            loadTables();
        }
        
        function joinTable(tableId, hasPassword) {
            if (hasPassword) {
                document.getElementById('modal-title').textContent = 'üîí ≈ûifreli Masa';
                document.getElementById('modal-body').innerHTML = `
                    <input type="password" id="join-password" placeholder="Masa ≈ûifresi">
                    <button class="btn btn-primary" onclick="joinWithPassword(${tableId})">‚úÖ Katƒ±l</button>
                `;
                showModal();
            } else {
                joinWithPassword(tableId, null);
            }
        }
        
        async function joinWithPassword(tableId, password) {
            hideModal();
            await api('POST', `/api/tables/${tableId}/join`, { password });
            showToast('Masaya katƒ±ldƒ±nƒ±z!');
        }
        
        async function leaveTable() {
            if (!currentTableId) {
                showLobby();
                return;
            }
            
            await api('POST', `/api/tables/${currentTableId}/leave`);
            showLobby();
        }
        
        async function startGame() {
            await api('POST', `/api/tables/${currentTableId}/start`);
        }
        
        // ================== BEKLEME ODASI ==================
        function showWaitingRoom(data) {
            stopAutoRefresh();
            hideAllScreens();
            document.getElementById('waiting-screen').classList.remove('hidden');
            document.getElementById('waiting-table-name').textContent = data.tableName;
            
            const players = [
                { name: 'Sen (Sen)', chips: data.myChips, isMe: true },
                ...data.others
            ];
            
            document.getElementById('waiting-players').innerHTML = players.map(p => `
                <div class="player-row">
                    <div class="player-avatar">üë§</div>
                    <div class="player-info">
                        <div class="player-name">${p.name}</div>
                        <div class="player-chips">${p.chips} chip</div>
                    </div>
                </div>
            `).join('');
            
            const startBtn = document.getElementById('start-game-btn');
            if (data.isCreator && data.others.length > 0) {
                startBtn.classList.remove('hidden');
            } else {
                startBtn.classList.add('hidden');
            }
        }
        
        // ================== OYUN EKRANI ==================
        function showGameScreen(data) {
            hideAllScreens();
            document.getElementById('game-screen').classList.remove('hidden');
            
            // Pot
            document.getElementById('pot').textContent = data.pot;
            
            // Diƒüer oyuncular
            const othersHtml = data.others.map(p => `
                <div class="player-row ${p.telegram_id === data.currentTurnName ? 'my-turn' : ''}">
                    <div class="player-avatar">üë§</div>
                    <div class="player-info">
                        <div class="player-name">${p.name}${p.stood ? ' ‚úã' : ''}</div>
                        <div class="player-chips">${p.chips} chip</div>
                    </div>
                    <div style="display: flex; gap: 2px;">
                        ${Array(p.cardCount).fill('<div style="width: 8px; height: 12px; background: white; border-radius: 2px;"></div>').join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('other-players').innerHTML = othersHtml || '<div class="text-center">Bekleniyor...</div>';
            
            // Benim kartlarƒ±m
            const myCardsHtml = data.myCards.map(c => {
                const isRed = c.suit === '‚ô•' || c.suit === '‚ô¶';
                return `<div class="card ${isRed ? 'red' : ''}"><div>${c.rank}</div><div>${c.suit}</div></div>`;
            }).join('');
            
            document.getElementById('my-cards').innerHTML = myCardsHtml || '<div class="text-center">Kart bekleniyor</div>';
            document.getElementById('hand-value').textContent = data.myValue || '0';
            
            // Timer
            if (data.isMyTurn) startTimer();
            else stopTimer();
            
            // UI durumu
            document.getElementById('bet-area').classList.add('hidden');
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('waiting-area').classList.add('hidden');
            document.getElementById('continue-area').classList.add('hidden');
            
            if (data.handStatus === 'betting' && data.needsBet) {
                showBetUI(data.myChips);
            } else if (data.handStatus === 'playing') {
                if (data.isMyTurn) {
                    document.getElementById('game-area').classList.remove('hidden');
                } else {
                    document.getElementById('waiting-area').classList.remove('hidden');
                    document.getElementById('current-turn').textContent = data.currentTurnName || '...';
                }
            }
        }
        
        function showBetUI(maxChips) {
            document.getElementById('bet-area').classList.remove('hidden');
            const slider = document.getElementById('bet-slider');
            slider.max = maxChips;
            slider.value = Math.min(10, maxChips);
            updateBet(slider.value);
            
            const presets = [10, 25, 50, 100, 250].filter(v => v <= maxChips);
            document.getElementById('chip-presets').innerHTML = presets.map(v => 
                `<div class="chip-btn" onclick="setBet(${v})">${v}</div>`
            ).join('');
        }
        
        function showContinueUI() {
            document.getElementById('bet-area').classList.add('hidden');
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('waiting-area').classList.add('hidden');
            document.getElementById('continue-area').classList.remove('hidden');
        }
        
        function updateBet(val) {
            document.getElementById('bet-amount').textContent = val;
        }
        
        function setBet(val) {
            document.getElementById('bet-slider').value = val;
            updateBet(val);
        }
        
        // ================== OYUN ƒ∞≈ûLEMLERƒ∞ ==================
        async function placeBet() {
            const amount = parseInt(document.getElementById('bet-slider').value);
            await api('POST', `/api/tables/${currentTableId}/bet`, { amount });
            document.getElementById('bet-area').classList.add('hidden');
        }
        
        async function hit() {
            await api('POST', `/api/tables/${currentTableId}/hit`);
        }
        
        async function stand() {
            await api('POST', `/api/tables/${currentTableId}/stand`);
        }
        
        async function vote(vote) {
            await api('POST', `/api/tables/${currentTableId}/continue`, { vote });
            document.getElementById('continue-area').classList.add('hidden');
        }
        
        // ================== TIMER ==================
        let timerSeconds = 15;
        
        function startTimer() {
            stopTimer();
            timerSeconds = 15;
            const bar = document.getElementById('timer-bar');
            bar.style.width = '100%';
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                bar.style.width = (timerSeconds / 15 * 100) + '%';
                if (timerSeconds <= 0) stopTimer();
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // ================== EKRAN Y√ñNETƒ∞Mƒ∞ ==================
        function hideAllScreens() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
        }
        
        function showLobby() {
            hideAllScreens();
            document.getElementById('lobby-screen').classList.remove('hidden');
            currentTableId = null;
            stopTimer();
            loadTables();
            startAutoRefresh();
        }
        
        // ================== MODAL ==================
        function showModal() {
            document.getElementById('modal').classList.remove('hidden');
        }
        
        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
        }
        
        // ================== TOAST ==================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('toast');
            
            setTimeout(() => {
                toast.classList.remove('toast');
            }, 3000);
        }
        
        // ================== RESULT ==================
        function showResult(msg) {
            let html = '<div class="table">';
            html += '<h3 style="text-align: center; margin-bottom: 16px;">' + (msg.message || 'El Sonucu') + '</h3>';
            
            (msg.playerHands || []).forEach(ph => {
                const cards = ph.cards.map(c => {
                    const isRed = c.suit === '‚ô•' || c.suit === '‚ô¶';
                    return `<div class="card ${isRed ? 'red' : ''}" style="width: 40px; height: 56px; font-size: 14px;"><div>${c.rank}</div><div>${c.suit}</div></div>`;
                }).join('');
                
                html += `
                    <div class="player-row ${ph.winner ? 'my-turn' : ''}">
                        <div class="player-avatar">${ph.winner ? 'üèÜ' : 'üë§'}</div>
                        <div class="player-info">
                            <div class="player-name">${ph.name} ${ph.busted ? 'üí•' : ''}</div>
                            <div style="display: flex; gap: 4px; margin-top: 4px;">${cards}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '<button class="btn mt-16" onclick="closeResult()">Kapat</button>';
            html += '</div>';
            
            document.getElementById('modal-title').textContent = 'Sonu√ß';
            document.getElementById('modal-body').innerHTML = html;
            showModal();
        }
        
        function closeResult() {
            hideModal();
        }
        
        // ================== INIT ==================
        connectWS();
        showLobby();
    </script>
</body>
</html>

